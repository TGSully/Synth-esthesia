/******************************************************************************
Student: Taylor Sullivan
Project: Synth-esthesia
Class/Term:Embedded Systems Summer 2018
Instructor: Dr. Bassem Alhalabi

Based off library example:
ISL29125_basics.ino
Simple example for using the ISL29125 RGB sensor library.
Jordan McConnell @ SparkFun Electronics
11 Apr 2014
https://github.com/sparkfun/ISL29125_Breakout

******************************************************************************/

#include <Wire.h>
#include "SFE_ISL29125.h"

// Declare sensor object
SFE_ISL29125 RGB_sensor;
const int buttonPin = PUSH2; 
const int octUp = P1_4;//octave up
const int octDwn = P1_5; //octave down

double octave=1; //starting octave at true frequency
 
void setup()
{
  // Initialize serial communication
  Serial.begin(9600);
  pinMode(PUSH2, INPUT_PULLUP);  
  pinMode(P1_4, INPUT_PULLUP);
  pinMode(P1_5, INPUT_PULLUP);
  // Initialize the ISL29125 with simple configuration so it starts sampling
  if (RGB_sensor.init())
  {
    Serial.println("Sensor Initialization Successful\n\r");
  }
  
  //int octave=1;
}

// Read sensor values for each color and print them to serial monitor
void loop()
{
  //int octave=1;
  int octUpState;
  int octDwnState;
  int buttonState; 
  buttonState = digitalRead(buttonPin);
  octUpState = digitalRead(octUp);
  octDwnState = digitalRead(octDwn);
  // Read sensor values (16 bit integers)
  unsigned int red = RGB_sensor.readRed();
  unsigned int green = RGB_sensor.readGreen();
  unsigned int blue = RGB_sensor.readBlue();
   //
   //convert to tone
  uint32_t sum = red;
  sum += green;
  sum += blue;

  float r, g, b;
  r = red; 
  r /= sum;
  g = green; 
  g /= sum;
  b = blue; 
  b /= sum;

  r *= 256; 
  g *= 256; 
  b *= 256;
  if (r > 255) r = 255;
  if (g > 255) g = 255;
  if (b > 255) b = 255;
  
    float remove, normalize;
  if ((b < g) && (b < r)) {
    remove = b;
    normalize = max(r-b, g-b);
  } 
  else if ((g < b) && (g < r)) {
    remove = g;
    normalize = max(r-g, b-g);
  } 
  else {
    remove = r;
    normalize = max(b-r, g-r);
  }
  // get rid of minority report
  float rednorm = r - remove;
  float greennorm = g - remove;
  float bluenorm = b - remove;
  // now normalize for the highest number
  rednorm /= normalize;
  greennorm /= normalize;
  bluenorm /= normalize;
  
Serial.println(rednorm);
Serial.println(greennorm);
Serial.println(bluenorm);   
 
////////// 
 double pitch;

  if (bluenorm <= 0.1) {
    // between red and green
    if (rednorm >= 0.99 && greennorm <= 0.55) {
      // between red and yellow
      Serial.println("RED");
      pitch = 220 * octave;
    }else if(rednorm >= 0.99 && greennorm < 0.99) {
      Serial.print("ORANGE");
      pitch = 247 * octave;
    }
    else if(rednorm >= 0.5 && greennorm >=0.99){
      // between yellow and green
      Serial.println("YELLOW");
      pitch = 277 * octave;
    }
    else{
    //else if(rednorm >= 0.5 && greennorm >=0.99){
      Serial.println("GREEN");
      pitch = 294 * octave;
    }
  } 
  else if (rednorm <= 0.1) {
        if (bluenorm >= 0.99 && greennorm <= 0.6){
      Serial.println("BLUE");
      pitch = 370 * octave;  
     } 
     else if (bluenorm >= 0.99 && greennorm <= 0.99){
      // between teal and blue
      Serial.println("TEAL");
      pitch = 330 * octave;
    }
  } else{
      // between teal and blue
      Serial.println("Violet");
      pitch = 415 * octave;
    }
    Serial.println();
  
  ///////////////octave select//////////////
  
  if(octUpState == LOW) {
    octave *=2;
    delay(250);
    Serial.println("octave up");
  }else if(octDwnState == LOW) {
    octave /=2;
    Serial.println("octave down");
    delay(250);
  }
   
   Serial.print("octave =  ");
   Serial.println(octave);

  ///////////trigger note///////////////////
  if(buttonState == LOW) { //while button pressed, play tone
    //while(buttonState != HIGH){tone(2, pitch);}
    tone(3, pitch);
    Serial.println("button pressed");
  }else if(buttonState == HIGH){
  Serial.println("unpressed");
   noTone(3);
  }
  

   //delay(10);
   //delay(2500);
}


